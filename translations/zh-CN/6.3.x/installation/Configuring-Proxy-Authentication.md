---
layout: 违约
title: CAS - 代理认证
category: 认证
---

# 代理身份验证

默认情况下启用了 CAS v1+ 协议的代理身份验证支持，因此完全由 CAS 客户端配置来利用代理身份验证功能。

<div class="alert alert-info"><strong>服务配置</strong><p>
请注意，注册表中的每个注册申请必须明确配置
，以便进行代理身份验证。 请参阅本指南 <a href="../services/Service-Management.html"></a>
了解注册册中的注册服务。</p></div>

建议将代理身份验证组件禁用，以便将战略性地避免代理 身份验证作为安全策略。

## 用例

代理身份验证的更常见案例之一是能够获得 也受 CAS 保护的后端 [REST-based] 服务的机票。 通常的情况是：

- 用户面临受 CAS 保护的应用程序 A。
- 后端的应用程序 A 需要联系服务 S 以生成数据。
- 服务 S 本身受 CAS 本身的保护。

由于联系人服务 S 通过服务器到服务方法，其中不涉及浏览器， 服务 S 将无法识别 SSO 会话已经存在。 在这些情况下， 申请 A 需要行使代理权才能获得服务 S 的代理票证。代理票证 传递到服务 S 的相关端点，以便通过 CAS 检索和验证，最终产生响应。

跟踪路线可能看起来像这样：

1. 浏览器导航到A。
2. 重定向到 CAS。
3. CAS 通过 `ST`进行认证并重定向回 A。
4. 试图验证 `ST`，并要求 `PGT`。
5. 中科院确认 `ST` 验证，并 `PGT`发放代理发票。
6. A 要求 CAS 为服务 S 生产 `PT` ，在其请求中提供 `PGT` 。
7. CAS为服务S生产PT。
8. 联系服务S端点，在请求中传递 `PT` 。
9. 服务S尝试通过CAS验证 `PT` 。
10. CAS 验证了 PT</code> `，并产生了成功响应。</li>
<li>服务 S 接收响应，并为 A 生成数据。</li>
<li>A 在浏览器中接收和显示数据。</li>
</ol>

<p spaces-before="0">有关详细信息，请参阅 <a href="../protocol/CAS-Protocol.html">CAS 协议</a> 。</p>

<h2 spaces-before="0">处理支持 SSL 的代理网址</h2>

<p spaces-before="0">默认情况下，CAS 将附带捆绑的 HTTP 客户端，该客户端部分负责回调 URL
以进行代理身份验证。 请注意，此 URL 还需要经 CAS 服务注册表授权
才能进行回拨。 <a href="../services/Service-Management.html">有关详细信息，请参阅本指南</a> 。</p>

<p spaces-before="0">如果回调 URL 由服务注册表授权，如果端点位于 HTTPS
并受 SSL 证书保护，CAS 还将尝试验证端点
证书的有效性，然后才能成功连接。 如果证书无效、过期、
缺少链条中的一步、自行签名或其他步骤，CAS 将无法执行回调。</p>

<p spaces-before="0">CAS 的 HTTP 客户端确实提供类似于 Java 平台的本地信托商店。
建议使用该信托商店来管理所有需要
导入平台的证书，以便 CAS 能够成功执行回调 URL。 虽然默认情况下，
本地信托商店到CAS是空的，但CAS仍将利用 <strong x-id="1"></strong> 违约和本地信托存储。
当然，本地信托存储只能用于 CAS 相关功能，信托存储文件
可以跨 CAS 和 Java 升级进行，当然还要由源控制系统管理，该系统应
托管所有 CAS 配置。</p>

<p spaces-before="0">要查看 CAS 属性的相关列表，请 <a href="../configuration/Configuration-Properties.html#http-client">查看本指南</a>。</p>

<h2 spaces-before="0">验证响应中的 PGT</h2>

<p spaces-before="0">在使用 <code>CAS20ProxyHandler` 可能不可取的情况下，如果调用回拨网址接收代理授予票证是不可行的，因此，CAS 可配置 在验证响应中直接返回代理授予票证 ID。 为了成功建立 CAS服务器与应用之间的信任，客户端应用程序生成了私钥/公共密钥对，然后 **在CAS内部分发和 配置的公钥** 。 CAS 将使用公钥加密授权票证 ID 的代理，并将在验证响应中发布新的属性 `<proxyGrantingTicketId>` ，前提是服务有权接收它。</p>

请注意，仅通过 CAS 验证响应执行代理授予票证 ID 的退货，前提是客户端 申请向 `/p3/服务验证` 端点（或 `/p3/代理验证`）发出请求。 将属性返还给 CAS 的其他方法，如 SAML1 将 **不** 支持代理授予票证的额外返回。

<div class="alert alert-warning">如果 CAS 在验证响应中配置为直接返回代理授予票证 ID，则
 <code>pgtIou</code> 参数从响应中省略，并且不执行对应用程序的回调。</div>

### 注册服务

一旦您从客户端应用程序所有者处收到公共密钥，它必须首先在 CAS 服务器的服务注册表内注册 。 持有上述公共密钥的服务还必须 授权接收 PGT 作为所选给定属性发布策略的属性。

```json
•
  "@class"："org.apereo.cas.服务.注册服务"，
  "服务id"："^https://.+"，
  "名称"："测试"，
  "id"：1，
  "评估号"：0，
  "属性发布政策"：{
    "@class"："org.apereo.cas.服务。返回授权发布政策"，
    "授权发布价格"：真正的
  }，
  "公共钥匙"：{
    "@class"："org.apereo.cas.服务.注册服务"，
    "位置"："类路径：公共.key"，
    "算法"："RSA"
  }
}
```

密钥对接必须由希望获得 PGT 的应用程序本身生成。 公共密钥与 CAS 共享。 应用程序使用私钥解密 PGT。 生成密钥对流的示例说明如下：

```bash
打开sl genrsa-出私人.key 4096
打开sl rsa-pubout-在私人.key-出公共.key-通知PEM-外型DER
打开-topk8-通知PER-外型DER-诺克里普特-在私人.key-出私人。p8
```

请注意，可能需要 `4096` 的大密钥大小，以便 CAS 能够加密 冗长的代理授予票证。 选择小密钥大小可能会阻止 CAS 正确 对票证进行加密，因为特定大小的加密算法可以处理的长度有限。

### 解密 PGT

客户端申请在 CAS 验证响应中收到 `代理"确认卡` ID 属性后，可以通过自己的私钥解密 。 由于该属性在默认情况下是 base64 编码的，因此在进行解密之前，需要先解码 。 下面是示例代码片段：

```java
最终地图<?, ?> 属性=...
最终字符串编码Pgt=（字符串）属性。
最后的私人钥匙私人钥匙=...
最后的密码密码=密码。获取安装（私钥。获取高利特）：
最后一个署名[]信用64=解码Base64（编码Pgt）：
密码. init （Cipher.DECRYPT_MODE， 私人钥匙）：
最后的旁特 [] 密码数据 = 密码. dofinal （信用 64）;
返回新字符串（密码数据）：
```
