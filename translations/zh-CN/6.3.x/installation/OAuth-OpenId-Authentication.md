---
layout: 违约
title: CAS - 非授权认证
category: 认证
---

# 非授权/开放身份验证

允许 CAS 充当非授权/开放式身份验证提供商。 请 [查看规范](https://oauth.net/2/) 以了解更多内容。

<div class="alert alert-info"><strong>中科院作为非授权服务器</strong><p>本页特别描述了如何启用
非授权/开放ID服务器支持CAS。 如果你想让CAS作为一个非授权/开放ID客户端
与其他供应商（如谷歌，Facebook等）沟通， <a href="../integration/Delegate-Authentication.html">看到这个页面</a>。</p></div>

## 行政终点

CAS 提供以下端点：

| 端点      | 描述                                                                                                                                                                              |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `奥特托肯斯` | 管理和控制 [OAuth2访问令牌](OAuth-OpenId-Authentication.html)。 `GET` 操作会生成所有访问/刷新令牌的列表。 `删除` 操作将删除以参数选择器形式提供的访问/刷新令牌。 （即 `/{token}`）。 `GET` 操作使用 `/{token}` 的参数选择器生成，将列出提取的访问/刷新令牌的详细信息。 |

## 配置

支持通过在 WAR 叠加中包括以下依赖性来启用：

```xml
<dependency>
  <groupId>组织.apereo.cas</groupId>
  <artifactId>卡-服务器-支持-授权-网络流</artifactId>
  <version>${cas.version}</version>
</dependency>
```

要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。

## 端点

启用非授权支持后，将提供以下端点：

| 端点                        | 描述                                                                                                                                         | 方法   |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ---- |
| `/授权2.0/授权`               | 授权用户并启动 CAS 认证流程。                                                                                                                          | `获取` |
| `/非授权2.0/访问`，`/非授权2.0/令牌` | 以纯文本或 JSON 获取访问令牌                                                                                                                          | `发布` |
| `/非授权2.0/配置文件`            | 通过 `access_token` 参数获取 JSON 中经过验证的用户配置文件。                                                                                                  | `获取` |
| `/授权2.0/反省`               | 查询 CAS，通过 [反省](https://tools.ietf.org/html/rfc7662)检测给定访问令牌的状态。 此端点期望 HTTP 使用 OAuth2 服务进行基本身份验证， `client_id` 并将 `client_secret` 关联为用户名和密码。 | `发布` |
| `/授权2.0/设备`               | 通过 [设备流协议](https://tools.ietf.org/html/draft-denniss-oauth-device-flow)批准设备用户代码。                                                           | `发布` |
| `/授权2.0/撤销`               | [撤销](https://tools.ietf.org/html/rfc7009) 访问或刷新令牌。 此端点期望 HTTP 使用 OAuth2 服务进行基本身份验证， `client_id` 并将 `client_secret` 关联为用户名和密码。              |      |

## 响应/授予类型

支持以下类型：它们允许您获得代表当前用户和OAuth 客户端应用程序的访问令牌。 使用访问令牌，您可以查询端点</code> `/配置文件，并获取用户配置文件。</p>

<h3 spaces-before="0">授权代码</h3>

<p spaces-before="0">授权代码类型为 UI 交互：用户将输入凭据，应接收代码，并将该代码交换为访问令牌。</p>

<table spaces-before="0">
<thead>
<tr>
  <th>端点</th>
  <th>参数</th>
  <th>响应</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>/授权2.0/授权`</td> 

</tr> 

</tbody> </table>

#### 证明密钥代码交换 （PKCE）

代码交换</a> 的

证明密钥 （PKCE， 发音为 pixie） 扩展描述了一种面向公共客户端的技术，以减轻被截获授权代码的威胁。 该技术涉及客户端首先创建一个秘密，然后在将授权代码交换为访问令牌时再次使用该秘密。 这样，如果代码被截获，它将没有用处，因为令牌请求依赖于初始机密。</p> 

授权端点的授权代码类型 `/非授权 2.0/授权` 能够接受以下参数以激活 PKCE：

| 参数                      | 描述                                    |
| ----------------------- | ------------------------------------- |
| `code_challenge`        | 使用下面的方法生成的代码挑战。                       |
| `code_challenge_method` | `普通的`， `S256`。 此参数是可选的，默认情况下假设 `普通` 。 |


`/非授权2.0/访问端口`  能够接受以下参数以激活PKCE：

| 参数              | 描述                                      |
| --------------- | --------------------------------------- |
| `code_verifier` | PKCE 请求的原始代码验证器，即应用程序最初在授权请求之前生成的代码验证器。 |


如果方法 `简单的`，那么中科院只需要检查所提供的 `code_verifier` 是否与预期的 `code_challenge` 字符串相匹配。 如果该方法 `S256`，那么中科院应采用所提供的 `code_verifier` ，并采用与客户最初相同的方法进行改造。 这意味着计算验证器的SHA256哈希和碱基64-url编码，然后将其与存储的 `code_challenge`进行比较。

如果验证器符合预期值，则 CAS 可以继续正常工作，发出访问令牌并做出适当响应。



### 令牌/隐式

`令牌` 类型也用于 UI 交互以及间接非交互式（即 爪哇脚本）应用程序。

| 端点          | 参数                                                   | 响应                   |
| ----------- | ---------------------------------------------------- | -------------------- |
| `/授权2.0/授权` | `response_type=令牌&client_id=ID&redirect_uri` | 访问令牌作为 `回调` 网址的锚定参数。 |




### 资源所有者凭据

`密码` 授予类型允许非授权客户端直接将用户的凭据发送到OAuth服务器。 对于网络和本地设备应用程序中值得信赖的第一方客户端来说，此授予是一次出色的用户体验。

| 端点            | 参数                                                                                                                | 响应    |
| ------------- | ----------------------------------------------------------------------------------------------------------------- | ----- |
| `/授权2.0/访问权限` | `grant_type=密码&client_id=ID`<br/>`&client_secret=<SECRET>`<br/>`&用户名=用户名&密码=密码` | 访问令牌。 |


由于此授予类型没有指定 `redirect_uri` ，因此将 CAS 认可并在服务注册表中匹配的服务标识符视为 `client_id` 。 您也可以选择性地传递 `服务` 或 `识别目标应用程序网址的 X 服务` 标题值。 标题值必须与链接到客户ID的注册表中的OAuth服务定义相匹配。



### 客户凭据

在 OAuth 授予的所有赠款中，最简单的是，此赠款适用于不需要特定用户访问数据的机器对机器身份验证 。

| 端点            | 参数                                                                     | 响应    |
| ------------- | ---------------------------------------------------------------------- | ----- |
| `/授权2.0/访问权限` | `grant_type=client_credentials&client_id=客户端&client_secret/秘密` | 访问令牌。 |


由于此授予类型没有指定 `redirect_uri` ，因此将 CAS 认可并在服务注册表中匹配的服务标识符视为 `client_id` 。 您也可以选择性地传递 `服务` 或 `识别目标应用程序网址的 X 服务` 标题值。 标题值必须与链接到客户ID的注册表中的OAuth服务定义相匹配。



### 刷新令牌

刷新令牌授予类型从刷新令牌（为以前的访问令牌发出）检索新访问令牌， 此之前的访问令牌过期时。

| 端点            | 参数                                                                                                                    | 响应      |
| ------------- | --------------------------------------------------------------------------------------------------------------------- | ------- |
| `/授权2.0/访问权限` | `grant_type=refresh_token&client_id]<ID>`<br/>`&client_secret=秘密&refresh_token REFRESH_TOKEN` | 新的访问令牌。 |




### 设备流

| 端点            | 参数                                                                              | 响应                    |
| ------------- | ------------------------------------------------------------------------------- | --------------------- |
| `/授权2.0/访问权限` | `response_type device_code&client_id=<ID>`                            | 设备授权网址、设备代码和用户代码。     |
| `/授权2.0/访问权限` | `response_type=device_code&client_id=<ID>&代码=<DEVICE_CODE>` | 一旦用户代码获得批准，就会有新的访问令牌。 |




## 授予类型选择

赠款是获取访问令牌的一种方法。 决定实施哪些授予取决于最终用户将使用的客户端类型，以及您希望为用户提供的体验。

![](https://alexbilbie.com/images/oauth-grants.svg)

要了解有关个人资料和赠款类型的更多资料，请 [](https://alexbilbie.com/guide-to-oauth-2-grants/)查看本指南。



## 注册客户端

每个非授权客户端必须定义为 CAS 服务（请注意新的 *客户端id* 和 *客户* 属性，具体到非授权）：



```json
•
  "@class"： "org. apereo. cas. 支持. aauth. 服务. oauth 注册服务"，
  "客户 ID"： "客户"，
  "客户秘密"： "客户秘密"，
  "服务id"："^（https|图片）：//<redirect-uri>.*"，
  "名称"："非授权服务"，
  "id"：100，
  "支持格兰特类型"："java.util.哈希集"，["。。。"，"。。。" []，
  "支持响应类型"："java.利用。哈希集"，[。。。"，"。。。" ]]
}
```


支持以下字段：

| 田         | 描述                                                                                                       |
| --------- | -------------------------------------------------------------------------------------------------------- |
| `客户ID`    | 申请/服务的客户标识符。                                                                                             |
| `客户安全`    | 申请/服务的客户秘密。                                                                                              |
| `支持格兰特类型` | 为这项服务收集支持的赠款类型。                                                                                          |
| `支持响应类型`  | 收集此服务的支持响应类型。                                                                                            |
| `旁路批准提示`  | 是否应绕过批准提示/同意屏幕。 违约 `虚假`。                                                                                 |
| `生成雷什托肯`  | 是否应与访问令牌一起生成刷新令牌。 违约 `虚假`。                                                                               |
| `续订刷新`    | 当前刷新令牌是否应过期，并在请求新访问令牌时生成（并沿发送）新令牌（ `grant_type` = `refresh_token`）。 只有当 `生成雷什托肯` 设置为 `真正的`时才可能。 违约 `虚假`。 |
| `j瓦特访问权`  | 是否应将访问令牌创建为 JWT。 违约 `虚假`。                                                                                |
| `服务ID`    | 授权重定向 URI（s）的模式，或与 `客户id` 相同，以防赠款类型（即 `client_credentials`等）不需要 `redirect_uri` 。                         |

<div class="alert alert-info"><strong>保留您需要的！</strong><p>我们鼓励您只保留和维护特定集成所需的属性和设置。 <strong>没有必要</strong> 获取所有服务字段的副本，并尝试根据它们的默认值再次配置它们。 虽然您可能希望保留副本作为参考，但此策略最终会导致升级不力，从而增加打破更改和混乱部署的机会。</p></div>

服务定义通常由 [服务管理](../services/Service-Management.html) 设施管理。

<div class="alert alert-warning"><strong>使用警告！</strong><p>CAS 目前没有严格执行出于向后兼容性原因的授权支持响应/授予类型的收集。 这意味着，如果未定义，服务定义和相关政策可能允许所有授予和响应类型。 请注意，此行为 <strong>在未来版本中</strong> 更改，因此，强烈建议立即在服务定义中声明每个配置文件的所有授权授予/响应类型，以避免将来出现意外。</p></div>

### 可加密客户端机密

OAuth 依赖方的客户端机密可定义为以 `{cas-cipher}`为前缀的加密值：



```json
•
  "@class"："组织.apereo.cas.支持.服务.未注册服务"，
  "客户id"："客户"，
  "客户秘密"："{cas-cipher}eyJhbGcijiuzMiIs.。。"，
  "服务id"："^（https|图片）：//<redirect-uri>。*"，
  "名称"："样本"，
  "id"：100

```


客户端机密可以使用 CAS 提供的密码操作手动或通过 [CAS 指挥线壳](Configuring-Commandline-Shell.html)进行加密。 要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。



### 属性释放

属性/索赔过滤和发布策略是根据非授权服务定义的。 有关详细信息，请参阅本指南</a> 。</p> 



## 非授权令牌到期政策

非授权令牌的到期政策由 CAS 设置和属性控制。 请注意，虽然访问和刷新令牌可能有其自己的使用寿命和到期政策，但它们通常与 CAS 单个登录会话的长度上限。

要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。



### 每种服务

某些非授权令牌的到期政策可按每份申请有条件地决定。 应聘服务 其令牌到期策略是偏离默认配置，必须按照以下片段进行设计。



#### 非航空法典



```json
•
  "@class"： "组织. apereo. cas. 支持. aauth. 服务. 非授权注册服务"，
  "客户id"："客户"，
  "客户秘密"："客户秘密"，
  "服务ID"："^（https|图片）：//<redirect-uri>。*"，
  "名称"："非授权服务"，
  "id"： 100，
  "代码探索政策"： [
    "@class"： "org. apereo. cas. 支持. aauth. 服务. 默认" 注册服务授权代码探索政策"，
    "使用次数"：1、
    "时间到生活"："10"
  =
}
```




#### 非授权访问令牌



```json
•
  "@class"： "组织. apereo. cas. 支持. aauth. 服务. 非授权注册服务"，
  "客户id"："客户id"，
  "客户秘密"："客户秘密"，
  "服务ID"："^（https|图片）：//<redirect-uri>。*"，
  "名称"："非授权服务"，
  "id"： 100，
  "访问探视探索政策"： [
    "@class"： "org. apereo. cas. 支持. aauth. 服务. 默认注册服务"
    "最大时间生活"："1000"，
    "时间到生活"："100"
  =
}
```




#### 非授权设备令牌



```json
•
  "@class"："org.apereo.cas.支持.服务.未注册服务"，
  "客户ID"："客户"，
  "客户秘密"："客户秘密"，
  "服务id"："^（https|图片）：//<redirect-uri>。*"
  "名称"："非授权服务"，
  "id"：100，
  "访问探视体验政策"：{
    "@class"："org.aper"
    "时间到生活"："100"
  =
}
```




#### 非授权刷新令牌



```json
•
  "@class"："org.apereo.cas.支持.aauth.服务.Oauth.服务"，
  "客户ID"："客户"，
  "客户秘密"："客户秘密"，
  "服务id"："^（https|图片）："/<redirect-uri>。*"
  "名称"："非授权服务"，
  "id"：100，
  "访问到的探索政策"：{
    "@class"："org.aper"
    "时间到生活"："100"
  =
}
```




## JWT 访问令牌

默认情况下，非身份存取令牌创建为不透明标识符。 还可以选择在每个服务的基础上将 JWT 生成为访问令牌：



```json
•
    "@class"： "组织. apereo. cas. 支持. aauth. 服务. 非授权注册服务"，
    "客户id"："客户id"，
    "客户秘密"："客户秘密"，
    "服务ID"："^（https|图片）：//<redirect-uri>。*"，
    "名称"："非授权服务"，
    "id"：100，
    "jwtAccessToken"：真实的，
    的"属性"：{
      "@class"："java.util.哈希马普"，
      "访问托肯AsJwt签名键" "：" [
         "@class"： "org. apereo. cas. 服务. 默认注册服务" ，
         "价值"： [ "java. util. 哈希塞特"， [ "。。。" ]]
      }，
      "访问托肯阿斯尤特加密钥匙"：{
           "@class"："org.apereo.cas.服务.默认注册服务"，
           "价值"："java.util.哈希塞特"，["。。。" ]]
      }，
      "访问托肯纳斯Jwt签名"：{
         "@class"："org.apereo.cas.服务.默认注册服务"
         "价值"："java.ul.il.哈希塞特"，"真实"[]]
      "，
      "访问托肯纳斯Jwt加密"：{
         "@class"："org.apereo.cas.服务。默认注册服务"
         "价值"："java.il.利用"，"哈希塞特"，"真实"]]
      "，
      "访问托肯Asjwt密码类型"：{
         "@class"："或
         "价值"："java.util.哈希塞特"，"ENCRYPT_AND_SIGN"]
      [
    ]
}
```


提供以下密码策略类型：

| 类型                 | 描述             |
| ------------------ | -------------- |
| `ENCRYPT_AND_SIGN` | 默认策略;加密值，然后签名。 |
| `SIGN_AND_ENCRYPT` | 签署值，然后加密。      |


签名和加密密钥也可以在每个服务的基础上定义，也可以通过 CAS 设置在全球范围内定义。 要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。



## 非授权用户配置文件结构

所请求的用户配置文件可通过应用程序使用以下选项进行渲染和消费。



### 嵌 套

默认情况下，请求的用户配置文件使用 `NESTED` 格式呈现，其中经过验证的委托人和属性分别放置在 `id` 和 `属性` 标记中。



```json
{
  "id"："casuser"，
  "属性"：{
    "电子邮件"："casuser@example.org"，
    "名称"："CAS"
  }，
  "东西"："其他"
}
```




### 平

此选项将主要属性平化一度，使其与 `id`处于同一水平。 最终有效载荷中的其他嵌套元件保持不变。



```json
{
  "id"："casuser"，
  "电子邮件"："casuser@example.org"，
  "名称"："CAS"，
  "东西"："其他"
}
```


要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。



### 习惯

如果您想要创建自己的配置文件结构，则需要设计一个组件并将其注册到 CAS 以处理用户配置文件的渲染：



```java
包组织. 阿佩雷奥. 卡斯. 支持. aauth;

@Configuration（"MyO授权配置"）
@EnableConfigurationProperties（cas配置.class）
公共类MyOAus配置=

    @Bean
    @RefreshScope
    公共OAuth20User专业查看器非授权使用者专业查看器（）{
        。。。
    •
}
```


[本指南](../configuration/Configuration-Management-Extensions.html) 了解有关如何将配置注册到 CAS 运行时间的更多信息。



## 节流

`/非授权 2.0/access Token` 支持可以启用身份验证限制，前提是覆盖 [打开身份验证 限制](Configuring-Authentication-Throttling.html) 支持。 然后，为支持限制的 OAuth 端点激活处理通常的 CAS 服务器端点以进行身份验证 和票证验证等的节流机制。

要查看 CAS 属性的相关列表，请 [查看本指南](../configuration/Configuration-Properties.html#oauth2)。



## 服务器配置

请记住，CAS 的 OAuth 功能需要会话亲和力（和可选会话复制）， ，因为整个登录流中的授权响应都通过服务器支持的会话存储机制存储。 您将需要相应地配置部署 环境和负载平衡器。



## 示例客户端应用程序

- [OAuth2 样本网络应用程序](https://github.com/cas-projects/oauth2-sample-java-webapp)



# 开放式身份验证

要将 CAS 配置为 OpenID 提供商，请 [](../protocol/OpenID-Protocol.html)查看此页面。
