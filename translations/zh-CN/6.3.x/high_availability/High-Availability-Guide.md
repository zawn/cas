---
layout: 默认
title: CAS-高可用性指南
category: 高可用性
---

# 高可用性指南（HA /群集）

高可用性的CAS部署是一种对各种故障模式做出响应的弹性，因此， 仍可继续提供SSO服务。 我们提供了一种推荐的体系结构，该体系结构为 计划和执行满足机构性能和可用性要求的CAS部署提供了起点。 它还提供了一个框架，用于理解由HA考虑所强加的CAS软件组件要求。

CAS的高可用性（HA）配置是通过确保有足够的冗余来实现的，以便 ，并且可以在不停机的情况下进行例行维护。 这可以使用多节点来实现，而使用具有高级虚拟机功能的单节点CAS则可以在较小程度上实现。 本文档将重点介绍实现HA所需的CAS Server组件。 对HA配置 更定量分析取决于所支持的基础结构和服务，这超出了本文档的范围。

CAS Server软件具有非常可靠的良好记录。 然而，CAS服务器仅仅是一个 的软件和硬件的小部分认证已遍历工作的顺利开展。 部署程序通常将群集 ，不仅用于负载处理，还用于故障转移。 即使未发生故障，有时也希望重新启动服务器 例如，如果在操作系统级别严重的安全修补程序 安装，服务器应立即重新启动。 在CAS服务器集群中，即使在最繁忙的时间内

漏洞时，操作单个服务器会将这样的重新启动延迟到不太繁忙的时间。 但是，最近随着虚拟机技术及其固有的 冗余和容错能力的日益普及，单节点CAS已经能够达到类似的质量。


## 推荐架构
下图突出显示了高可用性CAS部署的关键方面。

![推荐的HA架构](../images/recommended_ha_architecture.png "推荐的HA架构")

值得指出此体系结构的一些重要特征：

* 相关系统最多可以承受N-1个节点故障。 （其中N是节点总数。）
* CAS本身最多可以承受N-1个节点故障。
* 缓存节点的丢失不会导致复制缓存中SSO状态数据（即票证）丢失。
* 缓存节点的丢失可能会导致非复制缓存（例如memcached）中SSO状态数据的丢失。
* SSO状态数据的丢失总是很正常的：用户只需重新进行身份验证即可。

在继续详细讨论建议的体系结构的各个方面之前，我们为规划高可用性部署

<div class="alert alert-info"><strong>追求简单</strong><p>设计满足性能和可用性要求的最简单的解决方案。</p></div>

经验表明，简单性是成功且强大的HA部署的重要系统特征。 力求简单，您将得到很好的服务。


## 部署方案

### 单节点CAS，HA VM基础结构
通过实现在复杂的虚拟化环境中运行的单节点CAS可以实现高可用性。 从某种意义上说，这种简化方法可以简化CAS服务器配置，但 需要硬件虚拟化技术，而这种技术可能不存在且不可用，因此具有吸引力。

#### 物理架构
在单节点VM体系结构中，CAS服务器以及必要的先决条件和软件依赖项都部署在单个主机VM中。 在此部署方案下，默认的内存中票证注册表已足够，并且不需要Servlet会话复制为 。 足以满足HA和可伸缩性需求，那么这将简化部署配置，并且是推荐的方法。

#### 坚固性

硬件组件故障/恢复是虚拟化环境的功能，因此，CPU， 内存或电源的丢失不会导致CAS服务器故障。

#### 零停机维护方法

使用此配置无法实现真正的零停机维护（即对最终用户没有明显的影响）。 VM基础架构的克隆功能，可以在不停机的情况下进行维护和升级。 一旦新的CAS Server节点准备就绪，便可以实施简短的切换，这将有效地 结束所有当前的SSO会话。 这可以通过在部署 `cas.war` 之后在低流量时间安排Tomcat的重新启动来完成。

#### 可扩展性

CAS本身具有适度的计算要求，因此在典型的部署方案中，任何现代企业级服务器硬件都将变为 在最近的客户参与负载测试 ，单节点部署产生了良好的结果，CAS以每秒61个请求的速度处理200个并发用户，其中 大致每小时转换为108,000个身份验证事务。 这些数字当然是代表 并且任何基准都将高度依赖于本地基础结构。 VM环境应该能够扩展可用的CPU和内存，以满足广泛的需求。


### 多个CAS服务器节点

高可用的CAS部署由位于硬件负载均衡器后面的两个或更多节点组成，处于主动/被动或主动/主动模式的状态 总的来说，前者提供了 故障转移的简便性。后者，以增加复杂性为代价，提高了资源使用率并减少了服务中断。 在主CAS节点发生故障的情况下，可以通过手动或自动故障转移完成主动-被动配置。 可以使用群集票证注册表状态进行主动-主动配置，这样任何可用的CAS节点 都可以为CAS服务器的任何请求提供服务。 [有许多选项](../ticketing/Configuring-Ticketing-Components.html) 用于实现具有共享票证状态的双活配置。

通过实施在多个VM或物理主机上运行的多节点CAS部署，可以实现HA。 这种方法之所以具有吸引力，是因为它允许以零散增加部署复杂性为代价，对服务进行真正的零停机维护。

多节点CAS通常涉及以下内容：

* 安装CAS服务器的多个实例（以便可以在CAS服务不可用的情况下销毁一台或多台服务器）
* 配置CAS服务器的多个实例以共享票证状态（以便无论用户或服务与哪个CAS服务器进行交互，每个CAS服务器的响应都是相同的。）
* 配置解决方案以在群集的CAS服务器之间定向流量，以检测组件故障并从服务中删除出现故障的组件
* （可选）配置一种解决方案，以在整个CAS实例之间共享会话状态和会话故障转移（这通常是不合适的，因为最终用户CAS会话的寿命较短，并且体验比面向会话的请求响应风格更多） -改用短暂的粘性（又称持久会话）负载平衡（大型NAT部署可能会出现此问题）
* 制定适当的应变计划，以便在行使时恢复到所需的裕量，以防出现故障。 （例如，将三个CAS服务器实例群集在一起，以仅由两个实例提供服务的负载。）


#### 物理架构

可以通过VM或物理硬件来实现物理架构。 这是需要注意的重要 在一个共享的票状态模型（主动/主动模式），CAS服务器节点必须能够沟通门票 状态的所有节点，因此节点的需求之间的这种，防火墙的限制要宽松足以允许票证状态复制。

服务端点是在负载均衡器上配置的虚拟IP地址。 因此，负载均衡器将所有请求处理为 ，然后路由到可用的CAS节点。


#### 坚固性

如果CAS节点发生故障，则可以将 的工作负载和身份验证请求正确地重新路由到另一个CAS节点。 在故障转移场景中， 具体取决于用户在登录流中的位置，因此，一旦 ，请求已从故障节点登陆到克隆，用户可能需要 CAS登录屏幕。 可以通过Servlet会话状态复制消除这种故障模式。

#### 零停机维护方法

可以通过两种通用方法来进行维护工作，以使其包括将

- 在主动-被动模型中，可以在被动CAS节点上离线进行工作。 然后，对负载均衡器进行调整，以在准备好后 切换主动-被动节点。 这导致所有CAS SSO会话被重置，并且如果在高利用率的时间段内完成票证验证失败，则可能 有关此方法的更多详细信息，请参见下文。

- 在双活模型中，可以使一个节点脱机，同时至少一个其他 CAS服务器节点保持活动状态以响应请求。 一旦升级过程完成后， 服务器可以返回到池中，而从其他活动节点获得票状态。 某些 分布式票证注册表模型具有通过 数据来进行自我引导的能力，而无需进行任何手动配置或调整。 有关此方法的更多详细信息，请参见下文。


#### 可扩展性

通过将新的CAS节点添加到群集中，即可轻松实现可伸缩性。

#### 主动/被动模式

在主动/被动负载平衡配置中，N个节点中的1个在任何给定时间服务于所有请求。 由于无需在多个应用程序节点之间共享票证状态，因此简化了

特别是，将故障单存储在内存中的默认故障单注册表组件适合于活动/故障转移 设置，前提是节点故障会导致故障单丢失。 值得重复的是，票证丢失 导致应用程序正常运行失败，用户只需对CAS重新进行身份验证以创建新的SSO会话即可； 在先前的SSO会话下创建的CAS客户会话不会遭受数据中断或丢失。


#### 主动/主动模式

主动/主动模式下的负载均衡器同时向所有N个节点提供请求。 负载均衡器根据配置的算法 通常最不活跃或轮循。 在此系统架构中， 非常重要，使用票证存储区可以在其中放置票证，而无论哪个CAS节点请求它。

讨论此要求的起源很有启发性。 票证有两种交互，它们是从 根本不同的网络源发生的：

1. 用户的Web浏览器与CAS联系以生成票证。
2. 目标服务与票证联系CAS以对其进行验证。

由于两个请求都从不同的源地址流经负载平衡器，因此不可能保证两个请求都由同一CAS节点进行服务为 因此，无论票证请求的CAS节点 ，票证都必须是可定位的。 应该清楚为什么内存中存储不适用于主动/主动部署。

升级时在CAS服务器版本之间实现零停机时间转换。 可以使一个CAS节点实例脱机，进行维护，然后重新投入生产。 然后，对所有其他CAS节点重复相同的策略。

主动/主动部署还需要考虑以下事项：会话亲和力。 会话亲缘关系是 的功能，其中该设备对传入的请求执行状态管理，并 相同节点以进行后续请求。 默认情况下，不再需要此功能 因为CAS能够直接在客户端维护CAS登录/注销Web流的状态。 但是，如果需要，还提供了其他 选项，以允许servlet容器会话存储与复制选项 请参阅 [本指南](../webflow/Webflow-Customization-Sessions.html) 以了解更多信息。


#### 避免循环DNS

我们 _极力_ 建议避免循环DNS作为一个具有成本效益的替代硬件负载平衡器。 客户端高速缓存到期策略是完全不可控制的，并且典型的高速缓存到期时间比节点故障转移的 建议使用 [反向代理](http://httpd.apache.org/docs/current/mod/mod_proxy.html) 或 [软件负载平衡器](http://www.linuxvirtualserver.org/software/ipvs.html) 替代硬件。


### 房委会售票处

以下 [票证存储组件](../ticketing/Configuring-Ticketing-Components.html) 在易用性，可伸缩性和 容错能力之间提供了最佳折衷，并且适用于主动/被动和主动/主动设置。

存储技术的特定选择应由基础架构和专业知识以及性能 和可用性考虑决定。 拥有一个高性能存储，而您却缺乏 专业知识来在总是出现问题时进行故障排除，这几乎没有什么价值。

各种存储组件的技术考虑值得讨论，因为存在明显的 差异会影响可用性和性能特征。 像Ehcache和Hazelcast 这样的缓存系统提供了分布式缓存，该缓存提供了一个一致的条目视图，而与所联系的节点中的 分布式缓存依靠复制来提供一致性。 这样的缓存系统将票证存储在正好1个节点上，并使用确定性算法来查找包含票证的节点：

    N'= f（h（T），N1，N2，N3，... Nm）

其中 _h（T）_ 是票证ID的哈希， _N1 ... 纳米_ 是一组高速缓存节点，并且 _N”_ 是的部件 _Ñ... Nm_。

这些类型的缓存系统不需要复制，并且通常以降低一些 持久性为代价来提供简单性。

##### 安全缓存复制

许多基于缓存的票证注册表都支持通过网络安全地复制票证数据（ 以便在复制尝试时对票证进行加密和签名，以防止嗅探和窃听。 [有关更多信息，请参见本指南](../installation/Ticket-Registry-Replication-Encryption.html)


### 分发服务定义

在高可用性环境中，服务定义必须被CAS群集中 典型地，这可以通过利用集中式实现 [注册表实现](../services/Service-Management.html) 已备份 由JPA，LDAP，MongoDB的等 由文件系统支持的注册表需要设计一种确保手动或通过后台守护程序

### 连接池

我们 _极力_ 建议所有IO连接到后端数据存储，如LDAP目录和数据库， 杠杆连接池在可能的情况。 它充分利用了计算 （尤其是SSL / TLS连接）和IO资源的使用，同时提供了最佳的性能特征。


### 监控方式

中科院使用者通常实现监控使用的工具已经CAS服务的可用性 在监控其他企业Web应用程序的操作实践中使用。 默认情况下，CAS通过请求者的remote_address引入一个新的 适度监视页面，该页面带有身份验证。


### 频道机密性

假定通道机密性（通过SSL / TLS）对于CAS系统的安全状况至关重要。 这包括前通道（用户浏览器代理与CAS服务器之间）和后通道 （Web应用程序与CAS服务器之间）https流量，负载均衡器或 内容过滤器与CAS节点之间的任何中间代理流量，以及主要身份验证（例如LDAPS）和属性解析（基于SSL的JDBC）。 在任何阶段，隐私控制的任何破坏都将构成系统的整体安全性。


### 升级版

应通过建议的 [WAR覆盖方法](../installation/WAR-Overlay-Installation.html)进行CAS服务器升级。 建立为最佳 做法，覆盖方法使人们可以从众所周知的 公共存储库中无缝获取预期的CAS服务器版本，同时在下载的二进制工件上放置特定的自定义更改。 在覆盖方法的细节中，也可能需要将配置 外部化到 `cas.war` `cas.war` 文件的属性和日志记录配置可以在各个层上变化。 也就是说，外部化特定于环境的配置允许将相同的 `cas.war` 从服务器升级到服务器 并逐层升级，这增加了经过测试和验证生产之外的Web应用程序将按测试的方式运行的信心。在生产中。
